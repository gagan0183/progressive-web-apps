var picture,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("video"),canvas=document.querySelector("#canvas"),capButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image");function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(a){var n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n?new Promise(function(e,t){n.call(navigator,a,e,t)}):Promise.reject(new Error("getUserMedia is not implemented"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(function(e){imagePickerArea.style.display="block"})}function openCreatePostModal(){createPostArea.style.transform="translateY(0)",initializeMedia()}function closeCreatePostModal(){createPostArea.style.transform="translateY(100vh)",imagePickerArea.style.display="none",videoPlayer.style.display="none",canvas.style.display="none"}function onButtonClicked(e){console.log("clicked"),"caches"in window&&caches.open("user-requested").then(function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div"),a=(t.className="shared-moment-card mdl-card mdl-shadow--2dp",document.createElement("div")),n=(a.className="mdl-card__title",a.style.backgroundImage=`url(${e.image})`,a.style.backgroundSize="cover",t.appendChild(a),document.createElement("h2")),a=(n.className="mdl-card__title-text",n.textContent=e.title,a.appendChild(n),document.createElement("div"));a.className="mdl-card__supporting-text",a.textContent=e.location,a.style.textAlign="center",t.appendChild(a),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){clearCards();for(var t=0;t<e.length;t++)createCard(e[t])}capButton.addEventListener("click",function(e){canvas.style.display="block",videoPlayer.style.display="none",capButton.style.display="none",canvas.getContext("2d").drawImage(videoPlayer,0,0,canvas.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),picture=dataURItoBlob(canvas.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var url="https://learnpwa-ee647-default-rtdb.firebaseio.com/posts.json",networkDataReceived=!1;function sendData(){var e=(new Date).toISOString(),t=new FormData;t.append("id",e),t.append("title",titleInput.value),t.append("location",locationInput.value),t.append("file",picture,e+".png"),fetch("https://us-central1-learnpwa-ee647.cloudfunctions.net/storePostData",{method:"POST",body:t}).then(function(e){console.log("Sending data",e),updateUI()})}fetch(url).then(function(e){return e.json()}).then(function(e){console.log("from web",e),networkDataReceived=!0;var t,a=[];for(t in e)a.push(e[t]);updateUI(a)}),"indexedDB"in window&&readData("posts").then(function(e){networkDataReceived||(console.log("from Cache",e),updateUI(e))}),form.addEventListener("submit",function(e){e.preventDefault(),""===titleInput.value.trim()||""===locationInput.value.trim()?alert("Please enter valid input"):(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,picture:picture};writeData("sync-posts",t).then(function(){return e.sync.register("sync-new-posts")}).then(function(){document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your post was saved for syncing"})}).catch(function(e){console.log(e)})}):sendData())});